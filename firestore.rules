rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      // In a real production app, use Custom Claims for better security/performance
      // For now, we check the 'role' field on the user document
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "super_admin";
    }

    // --- Users Collection ---
    // public profiles are readable by everyone
    // sensitive data should be in a subcollection or private doc if needed
    match /users/{userId} {
      allow read: if true; // Public profiles need to be visible
      allow create: if isAuthenticated() && request.auth.uid == userId; // Users create their own profile on signup
      
      // Only owner can update, but prevent them from promoting themselves to super_admin
      allow update: if isOwner(userId) && 
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
      
      allow delete: if isOwner(userId) || isSuperAdmin();
    }

    // --- Links Collection ---
    match /links/{linkId} {
      // Public can read visible links
      allow read: if resource.data.isVisible == true || isOwner(resource.data.userId) || isSuperAdmin();
      
      // Owners can do full CRUD on their own links
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // --- Revenue Entries (Private) ---
    match /revenue_entries/{entryId} {
      allow read, write: if isOwner(resource.data.userId) || isSuperAdmin();
      allow create: if isOwner(request.resource.data.userId);
    }

    // --- System Logs (Super Admin Only) ---
    match /system_logs/{logId} {
      allow read: if isSuperAdmin();
      allow create: if isAuthenticated(); // Allow system actions (from client) to log, or restrict to Admin only
      allow update, delete: if false; // Logs should be immutable
    }

    // --- Generic Fallback ---
    match /{document=**} {
      allow read, write: if false; // Deny everything else by default
    }
  }
}
